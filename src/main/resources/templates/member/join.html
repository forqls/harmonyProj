<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<script src="https://www.google.com/recaptcha/enterprise.js?render=6LfAR74qAAAAAEi5J95fxzUQHUClaI_P-dZDS0wo"></script>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<link href="/css/reset.css" rel="stylesheet" type="text/css">
<link href="/css/common.css" rel="stylesheet" type="text/css">
<link href="/css/navBar.css" rel="stylesheet" type="text/css">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }


        #loginTop {
            margin-bottom: 10px;
            font-size: 24px;
            color: #333;
            text-align: center;
        }


        .subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }


        th {
            font-size: 14px;
            color: #555;
            padding-bottom: 10px;

        }

        #mem_id,
        #mem_name,
        #mem_email,
        #mem_address,
        #mem_pwd,
        #passwordConfirm {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }


        table button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #5cc78d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        table button:hover {
            background-color: #4caf75;
        }


        .main_menu_wrap a {
            color: #1a1a1a !important;
        }


        .login_wrap button {
            background: none;
            color: #1a1a1a !important;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

    </style>
    <meta charset="UTF-8">
    <title>Insert title here</title>
</head>
<body>
<div th:replace="~{/common/navbar.html :: navbar}"></div>
<script src="/js/tinymce/common.js"></script>
<form id="joinForm" method="post" action="/member/join">
    <table align="center" style="margin-top: 100px;">
        <tr>
            <td colspan="3" align="center">
                <h2 id="joinTop">회원가입</h2>
                <p class="subtitle">회원가입 시 입력한 정보로 비밀번호를 찾을 수 있습니다.</p>
            </td>
        </tr>

        <tr>
            <th>가입유형</th>
            <td colspan="2">
                <input type="radio" id="ck1" name="memType" value="0" checked><label for="ck1">일반 회원</label>
                <input type="radio" id="ck2" name="memType" value="1"><label for="ck2">주최자</label>
            </td>
        </tr>

        <tr>
            <th>이름</th>
            <td colspan="2">
                <input type="text" id="mem_name" name="memName" placeholder="이름을 입력하세요" required>
            </td>
        </tr>

        <tr>
            <th>아이디</th>
            <td>
                <input type="email" id="mem_id" name="memId" placeholder="사용 하실 아이디(이메일)를 입력하세요." required>
            </td>
            <td>
                <button type="button" id="checkId">아이디 중복확인</button>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <label id="confirmId"></label>
            </td>
        </tr>
        <tr>
            <th>주소</th>
            <td colspan="2">
                <input type="text" id="mem_address" name="memAddress" placeholder="주소를 입력하세요" required>
            </td>
        </tr>

        <tr>
            <th>비밀번호</th>
            <td colspan="2">
                <input type="password" id="mem_pwd" name="memPwd" placeholder="비밀번호를 입력하세요" required>
            </td>
        </tr>

        <tr>
            <th>비밀번호 확인</th>
            <td colspan="2">
                <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호를 한번 더 입력하세요"
                       required>
            </td>
        </tr>

        <tr>
            <td></td>
            <td><label id="confirmText"></label></td>
        </tr>

        <tr>
            <td colspan="3">
                <fieldset>
                    <legend>약관 동의</legend>
                    <label>
                        <input type="checkbox" id="allCheckbox" name="terms">
                        전체 동의
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" id="termsCheckbox" name="terms" required>
                        (필수) 온라인 서비스 이용약관
                    </label>
                    <br>
                    <label>
                        <input type="checkbox" id="agreeCheckbox" name="terms" required>
                        (필수) 온라인 서비스 이용을 위한 개인정보 수집 이용 동의
                    </label>
                </fieldset>
            </td>
        </tr>

        <tr>
            <td colspan="3">
                <button type="button" id="sendBtn" name="sendBtn">인증번호</button>
                <div class="form-group" id="mail_number" name="mail_number" style="visibility: hidden">
                    <input type="text" name="confirmNumber" id="confirmNumber" class="form-control" style="width:250px; margin-top: -10px" placeholder="인증번호 입력">
                    <span id="mail-check-warn"></span>
                    <button type="button" name="confirmBtn" id="confirmBtn" style="margin-top: 20px">이메일 인증</button>
                    <br>
                    <input type="hidden" id="Confirm" name="Confirm" value="">
                </div>
            </td>
        </tr>

        <tr>
            <td colspan="3" align="center">
                <!--<button type="button" id="join">회원가입</button>-->
                <input type="hidden" name="recaptchaResponse" id="recaptchaResponse">
                <button class="g-recaptcha"
                        data-sitekey="6LfAR74qAAAAAEi5J95fxzUQHUClaI_P-dZDS0wo"
                        data-callback='onSubmit'
                        data-action='submit' type="button" id="join">
                    회원가입
                </button>


                <!-- <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response">-->
            </td>
        </tr>

    </table>
</form>

<script type="text/javascript">
    let idCheck = false;
    let pwdCheck = false;
    let confirmCheck = false;

    document.getElementById('passwordConfirm').addEventListener('change', function () {
        const password = document.getElementById('mem_pwd').value;
        const confirmPassword = this.value;
        const confirmText = document.querySelector('#confirmText');

        if (password !== confirmPassword) {
            this.value = '';
            confirmText.innerText = '비밀번호가 일치하지 않습니다.';
            confirmText.style.color = 'red';
            pwdCheck = false;
        } else {
            confirmText.innerText = '비밀번호가 일치합니다.';
            confirmText.style.color = 'green';
            pwdCheck = true;
        }
    });

    document.querySelector('#mem_id').addEventListener('change', () => {
        document.querySelector('#confirmId').innerText = '다시 확인하세요.';
        document.querySelector('#confirmId').style.color = 'red';
        idCheck = false;
        confirmCheck = false;
    });

    document.querySelector('#mem_pwd').addEventListener('change', () => {
        document.querySelector('#confirmText').innerText = '다시 확인하세요.';
        document.querySelector('#confirmText').style.color = 'red';
        pwdCheck = false;
    });

    document.getElementById('checkId').addEventListener('click', () => {
        const id = document.querySelector('#mem_id').value;
        const confirmId = document.querySelector('#confirmId');
        console.log(id);
        if (id.trim() != '') {
            $.ajax({
                url: '/member/join.id',
                data: {id: id},
                success: (data) => {
                    if (data == 0) {
                        confirmId.innerText = '사용 가능한 아이디입니다.';
                        confirmId.style.color = 'green';
                        idCheck = true;
                    } else {
                        confirmId.innerHTML = "중복된 아이디 입니다.";
                        confirmId.style.color = 'red';
                        idCheck = false;
                    }
                },
                error: (data) => {
                    console.log(data);
                }
            });
        }
    });

    document.querySelector('#join').addEventListener('click', ()=>{
        if (idCheck && pwdCheck && confirmCheck){
            document.querySelector('#joinForm').submit();
        }else{
            alert('아이디 혹은 비밀번호를 확인하거나 이메일 인증을 하세요.');
        }
    });

    document.getElementById('allCheckbox').addEventListener('change', function () {
        const isChecked = this.checked;
        document.getElementById('termsCheckbox').checked = isChecked;
        document.getElementById('agreeCheckbox').checked = isChecked;
    });

    document.querySelectorAll('#termsCheckbox, #agreeCheckbox').forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
            const allCheckbox = document.getElementById('allCheckbox');
            const termsCheckbox = document.getElementById('termsCheckbox');
            const agreeCheckbox = document.getElementById('agreeCheckbox');

            if (termsCheckbox.checked && agreeCheckbox.checked) {
                allCheckbox.checked = true;
            } else {
                allCheckbox.checked = false;
            }
        });
    });

    document.querySelector('#sendBtn').addEventListener('click', ()=>{
        if (document.querySelector('#mem_id').value.trim() === ''){
            alert('아이디를 입력해 주세요.');
        }else{
            $.ajax({
                url: '/emailCheck',
                method:'post',
                data:{email:document.querySelector('#mem_id').value},
                success:data=>{
                    document.querySelector('#Confirm').value = data;
                    document.querySelector('#mail_number').style.visibility = 'visible';
                },
                error:data => console.log(data)
            });
        }
    });

    // document.getElementById('join').addEventListener('click', function (event) {
    //     event.preventDefault(); // 기본 제출 동작 방지
    //
    //     grecaptcha.enterprise.ready(function () {
    //         grecaptcha.enterprise.execute('6LfAR74qAAAAAEi5J95fxzUQHUClaI_P-dZDS0wo', { action: 'submit' })
    //             .then(function (token) {
    //                 console.log("reCAPTCHA Token:", token); // 콘솔에 토큰 출력
    //
    //                 // 백엔드로 reCAPTCHA 토큰 및 회원가입 정보 전송
    //                 fetch('/member/join', {
    //                     method: 'POST',
    //                     headers: {
    //                         'Content-Type': 'application/json'
    //                     },
    //                     body: JSON.stringify({
    //                         memId: document.getElementById('mem_id').value,
    //                         memPwd: document.getElementById('mem_pwd').value,
    //                         memName: document.getElementById('mem_name').value,
    //                         recaptchaResponse: token // reCAPTCHA 토큰 추가
    //                     })
    //                 })
    //                     .then(response => response.json())
    //                     .then(data => {
    //                         console.log("서버 응답:", data);
    //                         alert(data.message);
    //                     })
    //                     .catch(error => console.error("에러 발생:", error));
    //             })
    //             .catch(function (error) {
    //                 console.error("reCAPTCHA 오류:", error);
    //             });
    //     });
    // });


    document.getElementById('join').addEventListener('click', function (event) {
        event.preventDefault(); // 기본 제출 동작 방지

        grecaptcha.enterprise.ready(function () {
            grecaptcha.enterprise.execute('6LfAR74qAAAAAEi5J95fxzUQHUClaI_P-dZDS0wo', { action: 'submit' })
                .then(function (token) {
                    console.log("reCAPTCHA Token:", token); // 콘솔에 토큰 출력

                    // 백엔드로 reCAPTCHA 토큰 및 회원가입 정보 전송
                    const formData = new FormData();
                    formData.append('memId', document.getElementById('mem_id').value);
                    formData.append('memPwd', document.getElementById('mem_pwd').value);
                    formData.append('memName', document.getElementById('mem_name').value);
                    formData.append('recaptchaResponse', token); // reCAPTCHA 토큰 추가

                    fetch('/member/join', {
                        method: 'POST',
                        body: formData // FormData로 전송
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log("서버 응답:", data);
                            alert(data.message);
                        })
                        .catch(error => console.error("에러 발생:", error));
                })
                .catch(function (error) {
                    console.error("reCAPTCHA 오류:", error);
                });
        });
    });




    document.querySelector('#confirmBtn').addEventListener('click', ()=>{
        if (document.querySelector('#confirmNumber').value == document.querySelector('#Confirm').value){
            confirmCheck = true;
            alert('인증 완료');
        }else{
            confirmCheck = false;
            alert('인증 실패');
        }
    });
</script>


</body>
</html>